{% extends '_minbase.html' %}
{% load thaidate %}
{% load static %}

{% block title %}ARMIS :: รายการขอ นขต.ทอ.{% endblock %}

{% block header %}รายการขอ นขต.ทอ.{% endblock %}


{% block scriptlink %}
    <script src="https://unpkg.com/vue@next"></script>
{% endblock %}


{% block script %}

{% endblock %}

{% block style %}
  <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>
  <style>
    .icon-size {
        font-size: 20px;
        margin-top:0px;
    }
    .check-size {font-size: 10px;}

    thead tr:first-child, 
    thead tr:nth-child(2){
        text-align: center;
        text-valign: center;
    }

    .unit-list td:not(:last-child){
        text-align: center;
    }

    .unit-data-list td:not(:nth-child(5)){
        text-align: center;
    }

  </style>
{% endblock %}

{% block content%}
<div id="MainAPP">
    <div class="table-responsive">
        <div class="table-wrapper">
            <div class="table-title">
                <div class="row mb-2">
                    <div class="col-sm-10"><h4>ปีงบประมาณ 2565</h4> </div>
                    <div class="col-sm-2"></div>
                </div>
            </div>
            <table class="table table-bordered table-striped unit-list">
                    <col width="50">                    
                    <col width="120">
                    <col width="50">
                    <col width="50">
                    <col width="50">
                    <col width="50">
                    <col width="50">
                    <col width="50">
                    <col width="50">
                    <col width="80">
                    <col width="100">
                    <col width="150">                
                <thead>
                    <tr>
                        <th rowspan = 2>ลำดับ</th>
                        <th rowspan = 2>หน่วยงาน</th>
                        <th rowspan = 2 colspan = 2>รายการคำขอ</th>
                        <th colspan = 6>คำขอในระบบ</th>                                        
                        <th rowspan = 2><i class="fa fa-home text-primary icon-size" ></i> ได้รับจัดสรร</th>
                        <th rowspan = 2>หมายเหตุ</th>
                    </tr>
                    <tr>
                        <th colspan = 2>
                            <i class="fa fa-user text-black icon-size" ></i> ผู้ขอ
                        </th>
                        <th colspan = 2>
                            <i class="fa fa-users text-black icon-size" ></i> นขต.
                        </th>
                        <th>
                            <i class="fa fa-building text-black icon-size" ></i> กพ.ทอ.
                        </th>
                        <th>
                            <i class="fa fa-hourglass-start"></i> รอจัดสรร
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="obj in object_list">                        
                        <td>[[ obj.counter ]]</td>                        
                        <td>[[ obj.short_name ]]</td>                    
                        <td><a href = "#" @click = "show_unit_data_list([[ obj.unit_id ]])" ><i class="fa fa-list text-info icon-size" ></i></a></td>
                        <td><a href = "#" @click = "show_xls(obj.unit_id)"><i class="fas fa-file-excel text-success icon-size"></i></a></td>
                        <td>[[ obj.num_RP ]]</td>
                        <td>[[ obj.num_RS ]]</td>
                        <td>[[ obj.num_UP ]]</td>
                        <td>[[ obj.num_US ]]</td>
                        <td>[[ obj.num_PP ]]</td>
                        <td>[[ obj.num_PA ]]</td>
                        <td>[[ obj.num_GH ]]</td>
                        <td></td>
                    </tr>      
                </tbody>
            </table>
        </div>
    </div>
    {# เริ่ม Model แสดงรายการคำขอของหน่วย #}
    <div class="modal fade" id="unit_data_list_modal" tabindex="-1" aria-labelledby="unit_data_list_modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable ">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="unit_data_list_modalLabel">คำขอบ้านพัก [[ unit_data.short_name ]]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">                    
            <table class="table table-bordered table-hover table-striped caption-top unit-data-list" >
                    <col width="40">
                    <col width="40">
                    <col width="40">
                    <col width="40">
                    <col width="250">
                    <col width="150">
                    <col width="60">
                    <col width="100">
                    <col width="60">
                    <col width="60">
                    <col width="60">
                <thead>
                    <tr>
                        <th>#</th>
                        <th colspan = "3">เอกสาร</th>
                        <th>ยศ ชื่อ นามสกุล</th>
                        <th>เบอร์โทร</th>
                        <th>ผู้ขอ</th>
                        <th>นขต.</th>
                        <th>กพ.ทอ.</th>
                        <th>อนุมัติ</th>
                        <th>หมายเหตุ</th>                        
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(hm,i) in unit_data.HomeRequest">
                        <td>[[ i + 1 ]]</td>
                        <td>
                            <i class="fa fa-lock icon-size" v-bind:class="ProcessStepClass(hm.ProcessStep)" ></i>
                        </td>
                        <td><a href = "#" @click = "test_modal()"><i class="fa fa-eye text-info icon-size" ></i></a></td>
                        <td><a href = "#" @click = "show_doc(hm.id);"><i class="fas fa-file-word icon-size"></i></a></td>
                        <td>[[ hm.FullName ]]</td>
                        <td>[[ hm.MobilePhone ]]</td>
                        <td>
                            <div v-if="hm.RequesterDateSend">
                                <a href = "#" :title = "hm.RequesterDateSend"><i class="fa fa-check text-success icon-size" ></i></a>
                            </div>
                            <div v-else-if="hm.ProcessStep === 'RequesterProcess' ">
                                <small>ร่าง</small>
                            </div>
                        </td>
                        <td>
                            <a v-if="hm.UnitApprover" href = "#" :title = "[hm.UnitApproverName, hm.UnitApproverPhone, hm.UnitDateApproved ]"><i class="fa fa-check text-success icon-size" ></i></a>
                            <a v-else-if="hm.ProcessStep === 'UnitProcess'" href = "#" :title = "[hm.UnitRecieverName, hm.UnitRecieverPhone, hm.UnitDateRecieved ]">                                
                                <small>รับเรื่อง</small>
                            </a>                             
                            &nbsp;
                            <span v-if="hm.IsUnitEval" class="text-primary font-weight-bold" >
                                [[ hm.UnitTroubleScore ]]
                            </span>	  
                            <i v-else-if="hm.ProcessStep === 'UnitProcess' && !hm.IsUnitEval" class="far fa-tasks text-danger icon-size"></i>
                        </td>
                        <td>
                            <div v-if="hm.ProcessStep === 'UnitSended'  && ! hm.PersonApprover ">
                                <button class="btn btn-outline-primary btn-sm" @click="ConfirmPersonRecieved(i, hm.id)"><small>รับเรื่อง</small></button>                                
                            </div>  
                            <div v-else-if="hm.PersonApprover">                                
                                <a href = "#" :title = "[hm.PersonApproverName, hm.PersonApproverPhone, hm.PersonDateApproved ]"><i class="fa fa-check text-success icon-size" ></i></a>
                            </div>
                            

               
                            <div v-if="hm.IsPersonEval">
                                [[ hm.PersonTroubleScore ]]
                            </div>
                            <div v-else-if="hm.ProcessStep === 'PersonProcess' ">
                                <a href = "#" @click="evaluate(hm.id)" class="fa-stack" style="vertical-align: top;" >
                                    <i class="far fa-tasks text-warning icon-size"></i>
                                    <i class="fas fa-question text-danger fa-stack-1x check-size" style="margin-top: 10px;margin-left: 10px;"></i>
                                </a>
                            </div>
                        </td>
                        <td>
                            
                        </td>
                        <td>
                            <div v-if="hm.ProcessStep === 'PersonProcess' ">
                                <span :title = "[hm.PersonRecieverName, hm.PersonRecieverPhone, hm.PersonDateRecieved ]">                                
                                    <small>รอประเมิน</small>
                                </span>
                            </div>
                        </td>
                    </tr>
                </tbody>
                </table>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิดหน้าต่าง</button>                
            </div>
            </div>
        </div>
    </div> {# modal div#}

    {# Confirm modal #}
    <div class="modal fade" id="confirm_modal" tabindex="-1" aria-labelledby="confirm_modalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirm_modalLabel">ยืนยันรับเรื่อง</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">                
                รับเรื่องคำขอบ้านพักของ "[[ confirm_text ]]" <br><br>
                ** จะมีการบันทึกข้อมูลผู้รับเรื่องลงระบบ
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" @click="PersonRecieved" class="btn btn-primary">ยืนยัน</button>
            </div>
            </div>
        </div>
    </div>
</div> {# vue element div#}
{% endblock %}



{% block buttom_script %}

<script>
    const MainAPP = {
        delimiters: ['[[', ']]'],
        data() {
            return {
                test_counter: 0,
                unit_data_list_modal : null,
                confirm_modal : null,
                confirm_text :"",
                current_index: 0,
                current_hr_id: 0,

                object_list : [
                    {% for object in object_list %}
                    {
                        counter : {{ forloop.counter }},
                        short_name : "{{ object.Unit__ShortName }}",
                        unit_id : {{ object.Unit }},                        
                        num_RP : {{ object.Num_RP }},
                        num_RS : {{ object.Num_RS }},
                        num_UP : {{ object.Num_UP }},
                        num_US : {{ object.Num_US }},
                        num_PP : {{ object.Num_PP }},
                        num_PA : {{ object.Num_PA }},
                        num_GH : {{ object.Num_GH }}
                    } {% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                unit_data : {
                    short_name : "",
                    HomeRequest : []
                }
            }
        },
        mounted() {
            this.unit_data_list_modal = new bootstrap.Modal(document.getElementById("unit_data_list_modal"), {});
            this.confirm_modal = new bootstrap.Modal(document.getElementById("confirm_modal"), {});
            console.log("monted function");
        },
        methods : {
            show_unit_data_list(unit_id){
                urltext = "{% url 'HomeRequest:unit_list_admin'  99999 %}";
                new_urltext = urltext.replace("99999",unit_id)
                console.log(new_urltext);

                fetch(new_urltext)
                    .then(response => response.json())
                    .then(data => {
                        this.unit_data.HomeRequest = data;
                        this.unit_data.short_name = data[0]["UnitName"];
                        this.unit_data_list_modal.show();
                        console.log(this.unit_data.HomeRequest);
                    });

            },
            ConfirmPersonRecieved(index, hr_id){
                this.current_index = index;
                this.current_hr_id = hr_id;
                this.confirm_text = this.unit_data.HomeRequest[index]["FullName"];                
                this.confirm_modal.show();
            },
            PersonRecieved(){
                urltext = "{% url 'HomeRequest:update_process_step' 88888 '99999' %}";
                urltext = urltext.replace("88888",this.current_hr_id)
                new_urltext = urltext.replace("99999","PP")
                // console.log(new_urltext);
                // console.log(index, hr_id);

                fetch(new_urltext)
                    .then(response => response.json())
                    .then(data => {
                        if(data["success"])
                        {
                            this.confirm_modal.hide();
                            this.unit_data.HomeRequest[this.current_index]["ProcessStep"] = 'PersonProcess';
                        }
                        else
                            alert("เกิดข้อผิดพลาด ไม่สามารถรับเรื่องได้");
                    });
            },
            ProcessStepClass(hm_process_step)
            {
                // console.log(hm_process_step);
                var icon_style = 'text-secondary';
                switch(hm_process_step)
                {
                    case 'UnitSended' : icon_style = 'text-danger'; break;
                    case 'PersonProcess' : icon_style = 'text-warning'; break;
                }
                return icon_style;
            },
            show_doc(hm_id)
            {
                urltext = "{% url 'HomeRequest:doc' '99999' %}";
                docURL = urltext.replace("99999",hm_id)                
                window.open(docURL ,'_blank');
            },
            show_xls(unit_id)
            {
                urltext = "{% url 'HomeRequest:xls' '99999' %}";
                xlsURL = urltext.replace("99999",unit_id)                
                window.open(xlsURL ,'_blank');
            },
            evaluate(hm_id)
            {
                alert('ประเมิน ' + hm_id);
            }
        },
        
    }

    Vue.createApp(MainAPP).mount('#MainAPP')
</script>
{% endblock buttom_script %}