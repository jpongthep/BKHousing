{% extends '_minbase.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}
แบบฟอร์มขอบ้านพัก
{% endblock %}

{% block header %}
แบบฟอร์มขอบ้านพัก
{% endblock %}

{% block scriptlink %}
    <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
{% endblock %}

{% block script %}
    $(document).ready(function(){

        $('button[name="send"]').click(function() {
            var c = confirm("เมื่อส่งข้อมูลแล้วจะไม่สามารถแก้ไขข้อมูลในระบบได้ ยืนยันการบันทึกและส่งข้อมูล");
            return c;
        });

        $('button[name="save"]').click(function() {
            var c = confirm("บันทึกเพื่อส่งภายหลัง");
            return c;
        });
        
        $("#id_hr-Status").change(function() {
            married = this.value == 2 || this.value == 7;

            widow_divote = this.value == 3 || this.value == 4;

            $("#div_id_hr-IsHRISReport").toggle(married || widow_divote);

            $("#div_id_hr-SpouseName").toggle(married);
            $("#div_id_hr-SpousePID").toggle(married);
            $("#div_id_hr-SpouseAFID").toggle(married);
            
        });

        $("[name = 'hr-RentPermission']").change(function() {
            console.log($("[name = 'hr-RentPermission']:checked").val())

            has_rent_permission =$("[name = 'hr-RentPermission']:checked").val() == '3';

            $("#div_id_hr-RentStartDate").toggle(has_rent_permission);
            $("#div_id_hr-RentEndDate").toggle(has_rent_permission);
            $("#div_id_hr-RentOwner").toggle(has_rent_permission);
            $("#div_id_hr-RentOwnerPID").toggle(has_rent_permission);
            $("#div_id_hr-RentalCost").toggle(has_rent_permission);
            $("#div_RentAddress").toggle(has_rent_permission);
        });

        $("#id_hr-IsNeverRTAFHome").change(function() {
            IsNeverRTAFHome = ! $('#id_hr-IsNeverRTAFHome').is(":checked");
            $("#div_id_hr-RTAFHomeLeaveReason").toggle(IsNeverRTAFHome);
        });

        $('[data-priority]').change(function(){
            changed_item = $(this).data('priority');
            selected_value = $(`select[data-priority='${changed_item}']`).val();

            if($(this).find(':selected').val() == '')
            {
                $(`select[data-priority='${changed_item+1}']`).prop('disabled', 'disabled');                
            }
            else
            {
                $(`select[data-priority='${changed_item+1}']`).prop('disabled', false);
            }

            $(`select[data-priority='${changed_item+1}']`).val('');

            for(i = changed_item + 2; i <= 6; i++)
            {
                $(`select[data-priority='${i}']`).prop('disabled', 'disabled');
                $(`select[data-priority='${i}']`).val('');
            }
        });




        function cloneMore(selector, type) {
            var newElement = $(selector).clone(true);
            var total = $('#id_hr-' + type + '-TOTAL_FORMS').val();
            newElement.find(':input').each(function() {
                var name = $(this).attr('name').replace('-' + (total-1) + '-','-' + total + '-');
                var id = 'id_hr-' + name;
                $(this).attr({'name': name, 'id': id}).val('').removeAttr('checked');
            });
            newElement.find('label').each(function() {
                var newFor = $(this).attr('for').replace('-' + (total-1) + '-','-' + total + '-');
                $(this).attr('for', newFor);
            });
            total++;
            $('#id_hr-' + type + '-TOTAL_FORMS').val(total);
            $(selector).after(newElement);
        }

        $('#add_more').click(function() {
            cloneMore('#co_residence:last', 'service');
        });

        status = $("#id_hr-Status").val();
        married = status == 2 || status == 3;
        widow_divote = status == 4 || status == 5;

        $("#div_id_hr-SpouseName").toggle(married);
        $("#div_id_hr-SpousePID").toggle(married);
        $("#div_id_hr-SpouseAFID").toggle(married);
        $("#div_id_hr-IsHRISReport").toggle(married);

        
        has_rent_permission = {{ form.RentPermission.value|default_if_none:"0" }} == 3;

        $("#div_id_hr-RentStartDate").toggle(has_rent_permission);
        $("#div_id_hr-RentEndDate").toggle(has_rent_permission);
        $("#div_id_hr-RentOwner").toggle(has_rent_permission);
        $("#div_id_hr-RentOwnerPID").toggle(has_rent_permission);
        $("#div_id_hr-RentalCost").toggle(has_rent_permission);
        $("#div_RentAddress").toggle(has_rent_permission);
    });



{% endblock %}

{% block style %}
<style>
    .mouse_hover:hover{
        border-style: solid;        
    }

    select[disabled]{ color:#aaa;  }
</style>    
{% endblock%}

{% block content%}
<form method = "POST" enctype="multipart/form-data" >
    {% csrf_token %}  
    <div class="card shadow">
        <div class="card-header bg-info">
            <h5>ข้อมูลพื้นฐาน</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    {{ form.FullName|as_crispy_field  }}
                </div>
                <div class="col-md-3">
                    {{ form.Position|as_crispy_field  }}
                </div>
                <div class="col-md-2">
                    {{ form.Unit|as_crispy_field  }}
                </div>
                <div class="col-md-2">
                    {{ form.Salary|as_crispy_field }}
                </div>
                <div class="col-md-2">
                    {{ form.AddSalary|as_crispy_field  }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-2">
                    {{ form.Status|as_crispy_field }}
                </div>
                <div class="col-md-3">
                    {{ form.IsHRISReport|as_crispy_field  }}
                </div>
                <div class="col-md-3">
                    {{ form.SpouseName|as_crispy_field  }}
                </div>
                <div class="col-md-2">
                    {{ form.SpousePID|as_crispy_field  }}
                </div>
                <div class="col-md-2">
                    {{ form.SpouseAFID|as_crispy_field  }}
                </div>

            </div>
            <div class="row">
                <div class="col-md-2">
                    {{ user_current_data_form.OfficePhone|as_crispy_field }}
                </div>
                <div class="col-md-2">
                    {{ user_current_data_form.MobilePhone|as_crispy_field  }}
                </div>
                <div class="col-md-2">
                    {{ user_current_data_form.RTAFEMail|as_crispy_field  }}
                </div>
                <div class="col-md-2">
                    {{ user_current_data_form.email|as_crispy_field  }}
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow mt-3">
        <div class="card-header bg-secondary text-white">
            <h5>ข้อมูลที่พักอาศัยและการเบิกค่าเช่าบ้าน</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    {{ form.Address|as_crispy_field }}
                </div>
                <div class="col-md-2">
                    <div id="div_id_hr-GooglePlusCodes1" class="mb-3">
                        <label for="id_hr-GooglePlusCodes1" class="form-label">
                            Google Plus Codes 1
                            <img src = "{% static 'images/button_help.png' %}" width = 25 height = 25 
                                 class = "help_goocle_code_plus" 
                                 data-bs-toggle="modal" data-bs-target="#google_help_modal">

                        </label>
                        <input type="text" name="hr-GooglePlusCodes1" maxlength="20" class="textinput textInput form-control" id="id_hr-GooglePlusCodes1">
                    </div>
                    <input id="zipcode1" type="hidden">
                </div>                
            </div>
            <div class="row">
                <div class="col-md-12">
                     {{ form.TravelDescription|as_crispy_field  }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-2">
                    {{ form.RentPermission|as_crispy_field }}
                </div>
                <div class="col-md-2">
                    {{ form.RentStartDate|as_crispy_field  }}                    
                </div>
                <div class="col-md-2">
                    {{ form.RentEndDate|as_crispy_field  }}                    
                </div>
                <div class="col-md-2">
                    {{ form.RentOwner|as_crispy_field  }}
                </div>
                <div class="col-md-2">
                    {{ form.RentOwnerPID|as_crispy_field  }}
                </div>
                <div class="col-md-2">
                    {{ form.RentalCost|as_crispy_field  }}
                </div>
            </div>
            <div class="row" id = "div_RentAddress">
                <div class="col-md-6">
                    {{ form.RentAddress|as_crispy_field }}
                </div>
                <div class="col-md-2">
                    <div id="div_id_hr-GooglePlusCodes2" class="mb-3">
                        <label for="id_hr-GooglePlusCodes2" class="form-label">
                            Google Plus Codes 2
                            <img src = "{% static 'images/button_help.png' %}" width = 25 height = 25  
                                 class = "help_goocle_code_plus" 
                                 data-bs-toggle="modal" data-bs-target="#google_help_modal">
                        </label>
                        <input type="text" name="hr-GooglePlusCodes2" maxlength="20" class="textinput textInput form-control" id="id_hr-GooglePlusCodes2">
                    </div>
                    <input id="zipcode2" type="hidden">
                </div>                

            </div>            
        </div>
    </div>

    <div class="card shadow mt-3">
        <div class="card-header bg-warning">
            <h5>ข้อมูลความจำเป็นและความเดือดร้อน</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    {{ form.IsNotBuyHome|as_crispy_field }}
                    {{ form.IsNotOwnHome|as_crispy_field  }}
                    
                </div>
                <div class="col-md-3">
                    {{ form.IsNotRTAFHome|as_crispy_field  }}
                    {{ form.IsMoveFromOtherUnit|as_crispy_field  }}
                </div>                
                <div class="col-md-3">
                    {{ form.IsHomelessEvict|as_crispy_field }}
                    {{ form.IsNeverRTAFHome|as_crispy_field  }}                 
                </div>
                <div class="col-md-3">
                    {{ form.IsHomelessDisaster|as_crispy_field  }}
                    {{ form.ImportanceDuty|as_crispy_field  }}
                </div>
            </div>        
            <div>
                <div class="col-md-12">
                    {{ form.RTAFHomeLeaveReason|as_crispy_field  }}
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    {{ form.OtherTrouble|as_crispy_field  }}    
                </div>
            </div>  
        </div>      
    </div>

    <div class="card shadow mt-3">
        <div class="card-header bg-dark text-white">
            <h5>ข้อมูลการเรียงลำดับความต้องการ</h5>
        </div>
        <div class="card-body">
            <div class="row">
            {% if request.user.Rank < 30411 %}
                <div class="col-md-2">
                    {{ form.IsHomeNeed|as_crispy_field }}
                </div>
            {% endif %}
                <div class="col-md-2">
                    {{ form.IsFlatNeed|as_crispy_field  }}
                </div>
            {% if request.user.current_status in "2,7" %}
                <div class="col-md-2">
                    {{ form.IsShopHouseNeed|as_crispy_field  }}
                </div>
            {% endif %}
            </div>        
            <div class="row">
                <div class="col-md-2">
                    {{ form.ZoneRequestPriority1|as_crispy_field  }} 
                </div>                
                <div class="col-md-2">
                    {{ form.ZoneRequestPriority2|as_crispy_field  }} 
                </div>                
                <div class="col-md-2">
                    {{ form.ZoneRequestPriority3|as_crispy_field  }} 
                </div>                
                <div class="col-md-2">
                    {{ form.ZoneRequestPriority4|as_crispy_field  }} 
                </div>                
                <div class="col-md-2">
                    {{ form.ZoneRequestPriority5|as_crispy_field  }} 
                </div>                
                <div class="col-md-2">
                    {{ form.ZoneRequestPriority6|as_crispy_field  }} 
                </div>                

            </div>        

        </div>      
    </div>
    <div class="card shadow mt-3">
        <div class="card-header bg-primary text-white">
            <h5>เอกสารประกอบคำร้อง</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    {{ form.HouseRegistration|as_crispy_field  }} 
                </div>                
                <div class="col-md-3">
                    {{ form.DivorceRegistration|as_crispy_field  }} 
                </div>                
                <div class="col-md-3">
                    {{ form.SpouseDeathRegistration|as_crispy_field  }} 
                </div>                
                <div class="col-md-3">
                    {{ form.HomeRent6006|as_crispy_field  }} 
                </div>                
            
            </div>        
            <div class="row">
                <div class="col-md-3">
                    {{ form.SpouseHomeRent6006|as_crispy_field  }} 
                </div>                
                <div class="col-md-3">
                    {{ form.SalaryBill|as_crispy_field  }} 
                </div>                
                <div class="col-md-3">
                    {{ form.SpouseApproved|as_crispy_field  }} 
                </div>
            </div>
        </div>      
    </div>

    <div class="card mt-3 shadow">
        <div class="card-header  bg-success text-white">
            <h5>ผู้พักอาศัยร่วม</h5>
        </div>
        <div class="card-body">
        {{ co_resident_formset.management_form }}
        {{ co_resident_formset.non_form_errors }}
        {% for formset in co_resident_formset %}
            {% for hidden in formset.hidden_fields %}
                {{ hidden }}
            {% endfor %}
            
            <div class="inline {{ co_resident_formset.prefix }}" id = "co_residence">						
                <div class="row mouse_hover ">
                        <div class="col-2 mt-1">
                            {{ formset.FullName|as_crispy_field}}
                        </div>
                        <div class="col-1">
                            {{ formset.Relation|as_crispy_field}}
                        </div>
                        <div class="col-2">
                            {{ formset.PersonID|as_crispy_field}}
                        </div>
                        <div class="col-2">
                            {{ formset.BirthDay|as_crispy_field}}
                        </div>
                        <div class="col-2">
                            {{ formset.Occupation|as_crispy_field}}
                        </div>
                        <div class="col-1">
                            {{ formset.Salary|as_crispy_field}}
                        </div>
                        <div class="col-1">
                            {{ formset.Education|as_crispy_field}}
                        </div>                        
                        <div class="col-1">
                            {{ formset.DELETE|as_crispy_field}}
                        </div>                            
                </div>	                    				
            </div>
        {% endfor %}
        </div>
        
    </div>
    {% comment %} <input type="button" class="btn btn-info" value="เพิ่มผู้พักอาศัย" id="add_more"> {% endcomment %}

    <div class = "mt-3">
        <button type="submit" name="save" class="btn btn-warning">บันทึกร่าง</button>        
  <button type="submit" name="send" class="btn btn-primary">บันทึกและส่งรายงาน</button>        
    </div>
  

  </form>
  
  <!-- Button trigger modal -->

<!-- Modal -->
<div class="modal fade" id="google_help_modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-body text-center">      
        <img src = "{% static 'images/google_plus_code.png'%}" width = 886 height = 634>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>        
      </div>
    </div>
  </div>
</div>
{% endblock %}