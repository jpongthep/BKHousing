{% extends '_minbase.html' %}
{% load thaidate %}
{% load static %}

{% block title %}
รายการขอบ้านพัก
{% endblock %}

{% block scriptlink %}
    <script src="https://unpkg.com/vue@next"></script>
    <script src="{% static 'my_script/modal-with-custom-action.js'%}"></script>
{% endblock %}


{% block script %}
<script>
    function modal_hr_detail(hr_id)
    {
        urltext = "{% url 'HomeRequest:md' 99999 %}"
        
        new_urltext = urltext.replace("99999",hr_id)
        console.log(new_urltext)
        fetch_show_modal(new_urltext);
    }

    function show_processstep(process_step)
    {
        var all_process_step = ['RP','RS','UP','US','PP','PA','GH','RC']
        all_process_step.forEach(function (item, index) {
            table_rows = document.getElementsByClassName(item);
            for (var i = 0; i < table_rows.length; i++) {
                if(process_step == 'ALL')
                {
                    table_rows.item(i).style.display = 'table-row';
                    document.getElementById("btn_show_all").style.display = 'none';
                }
                else if(item != process_step)
                {
                    document.getElementById("btn_show_all").style.display = 'inline';
                    table_rows.item(i).style.display = 'none';
                }
                else
                    table_rows.item(i).style.display = 'table-row';
            }
        });
    }

    

    


</script>
{% endblock %}

{% block style %}
  <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>

  
  <style>
    .icon-size {font-size: 20px;}
    .check-size {font-size: 10px;}

    thead tr:first-child{
        text-align: center;
    }

    table td:not(:nth-child(5)):not(:last-child){
        text-align: center;
    }

    td a {
        font-size:smaller;
        text-decoration: none;
        color:green;
    }

  </style>
{% endblock %}

{% block header %}
รายการคำขอ {{ request.user.CurrentUnit}}
{% endblock %}

{% block header_right %}{{ request.user.FullName}}{% endblock %}

{% block CardRow %}
    {% comment %} <div class = "row">
        {% include "project/card.html" with bgcolor="bg-light" text_color="text-dark" awesome="fa-pen" number=hr.Num_RP text="เริ่มกรอก" click="show_processstep('RP');" %}  
        {% include "project/card.html" with bgcolor="bg-danger" text_color="text-white" awesome="fa-list" number=hr.Num_RS text="ส่งหน่วย" click="show_processstep('RS');"%}
        {% include "project/card.html" with bgcolor="bg-warning" text_color="text-white" awesome="fa-cog fa-spin" number=hr.Num_UP text="นขต.รับ" click="show_processstep('UP');"%}
        {% include "project/card.html" with bgcolor="bg-success" text_color="text-white" awesome="fa-check" number=hr.Num_US text="นขต.ส่ง" click="show_processstep('US');"%}
        {% include "project/card.html" with bgcolor="bg-secondary" text_color="text-white" awesome="fa-paperclip" number=hr.Num_PPPA text="กพ.รับเรื่อง" click="show_processstep('PP');"%}
        {% include "project/card.html" with bgcolor="bg-primary" text_color="text-white" awesome="fa-home" number=hr.Num_GH text="รับจัดสรร" click="show_processstep('GH');"%}
    </div>  {% endcomment %}
{% endblock %}

{% block content%}
    {% if not object_list %}
        <h3>ไม่มีข้าราชการส่งรายงานขอบ้านพักในระบบ</h3>
    {% else %}
        <div id="MainAPP">
            <div class = "row">
                <div v-for="index in 6" :key="index" class = "mt-2 col-xl-2 col-lg-3 col-md-4 col-sm-6 col-6">
                    <div class = "card text-center shadow rounded-top">
                        <div class = "card-header" v-bind:class = "[card_static[index-1].color, card_static[index-1].bgcolor]">
                            <div class = "row align-items-center">
                                <div class = "col">
                                    <i class="fa fa-2x" v-bind:class = "[card_static[index-1].awesome]"></i>
                                </div>
                                <div class = "col">
                                    <h3 class = "display-6">
                                        [[ num_report[index-1] ]]
                                    </h3>
                                    <h6>[[ card_static[index-1].text ]]</h6>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <h6 class = "text-dark" @click = "filter_homerequest(index);" style ="cursor: pointer;">แสดงข้อมูล <i class="fa fa-arrow-alt-circle-right"></i></h6>
                        </div>
                    </div>
                </div>
            </div>                   
            <div class = "row mt-4">
                <div class="row mb-2">
              
                    <div class="col-md-7">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" checked type="checkbox" @click = "toggle_display('น.5+');" >
                            <label class="form-check-label">น.5 + </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" checked type="checkbox" @click = "toggle_display('สัญญาบัตร');" >
                            <label class="form-check-label">สัญญาบัตร</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" checked type="checkbox" @click = "toggle_display('ประทวน');" >
                            <label class="form-check-label">ประทวน</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" checked type="checkbox" @click = "toggle_display('โสด');" >
                            <label class="form-check-label">โสด</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" checked type="checkbox" @click = "toggle_display('สมรส-อยู่ร่วมกัน');"  >
                            <label class="form-check-label">สมรส-อยู่ร่วมกัน</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" checked type="checkbox" @click = "toggle_display('สมรส-แยกกันอยู่');"  >
                            <label class="form-check-label">สมรส-แยกกันอยู่</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" checked type="checkbox" @click = "toggle_display('หย่า/ม่าย');"  >
                            <label class="form-check-label">หย่า/ม่าย</label>
                        </div>                        
                    </div>
            
                    <div class="col-md-2">                    
                        <button class = "btn btn-primary shadow" v-if="filter_data != 'all'" @click="filter_data = 'all'">แสดงทั้งหมด</button>
                    </div>
                   <div class="col-sm-3 text-end">
                        <a href = '{% url 'HomeRequest:xls' request.user.CurrentUnit.id%}' type="button" class="btn btn-success m-1"><i class="fa fa-file-excel"></i> excel</a>
                        <a href = '{% url 'HomeRequest:doc_unit' request.user.CurrentUnit.id%}' type="button" class="btn btn-primary text-white"><i class="fa fa-file-word"></i> word</a>
                    </div>
                </div>

            </div>                   
            <table class="table table-bordered table-hover table-striped caption-top unit-data-list mt-2" >
                    <col width="40">
                    <col width="40">
                    <col width="40">
                    <col width="40">
                    <col width="250">
                    <col width="80">
                    <col width="150">
                    <col width="60">
                    <col width="100">
                    <col width="60">
                    <col width="60">
                    <col width="60">
                <thead>
                    <tr>
                        <th>#</th>
                        <th colspan = "3">เอกสาร</th>
                        <th>ยศ ชื่อ นามสกุล</th>
                        <th>สถานภาพ</th>
                        <th>เบอร์โทร</th>
                        <th>ผู้ขอ</th>
                        <th>นขต.</th>
                        <th>กพ.ทอ.</th>
                        <th>อนุมัติ</th>
                        <th>หมายเหตุ</th>                        
                    </tr>
                </thead>
                <tbody>
                    <template v-for="(hm,i) in unit_data.HomeRequest" >
                        <tr v-if="(filter_data == 'all' || hm.ProcessStep == filter_data) && show_rank_status.includes(hm.Status)">
                            <td>[[ i + 1 ]] </td>
                            <td>
                                <i v-if="hm.ProcessStep != 'RequesterProcess'" class="fa fa-lock icon-size" v-bind:class="ProcessStepClass(hm.ProcessStep)" ></i>
                                <i v-else class="fa fa-edit icon-size text-primary" ></i>
                            </td>
                            <td><a href = "#" @click = "show_hr_detail(hm.id);"><i class="fa fa-eye text-info icon-size" ></i></a></td>
                            <td><a href = "#" @click = "show_doc(hm.id);"><i class="fas fa-file-word icon-size text-info"></i></a></td>
                            <td>[[ hm.FullName ]]</td>
                            <td>[[ hm.Status ]]</td>
                            <td>[[ hm.MobilePhone ]]</td>
                            <td> <!--Requester -->
                                <div v-if="hm.RequesterDateSend">
                                    <a href = "#" :title = "hm.RequesterDateSend"><i class="fa fa-check text-success icon-size" ></i></a>
                                </div>
                                <div v-else-if="hm.ProcessStep === 'RequesterProcess' ">
                                    <small>ร่าง</small>
                                </div>
                            </td>
                            <td> <!-- Unit -->
                                <div v-if="hm.ProcessStep === 'RequesterSended'">
                                    <button class="btn btn-outline-primary btn-sm" @click="ConfirmChangeProcessStep(i, hm.id,'UP')"><small>รับเรื่อง</small></button>                                
                                </div>  
                                <div v-else-if="hm.ProcessStep==='UnitProcess'">                                
                                    <strong v-if="hm.IsUnitEval">
                                        <a href = "#" @click="evaluate(hm.id, 'edit');" :title = "[hm.UnitRecieverName, hm.UnitRecieverPhone, hm.UnitDateRecieved ]">
                                            [[ hm.UnitTroubleScore ]] 
                                        </a> &nbsp;
                                        <button class="btn btn-outline-primary btn-sm" @click.native.prevent="ConfirmChangeProcessStep(i, hm.id,'US')"><small>ส่งเรื่อง</small></button>                                
                                    </strong>
                                    <a  v-else href = "#" @click="evaluate(hm.id, 'edit');" :title = "[hm.UnitRecieverName, hm.UnitRecieverPhone, hm.UnitDateRecieved ]">
                                        <span class="fa-stack" style="vertical-align: top;">
                                            <i class="far fa-tasks text-danger  icon-size"></i>
                                            <i class="fas fa-question text-warning fa-stack-1x check-size" style="margin-top: 10px;margin-left: 10px;"></i>
                                        </span>                                                    
                                    </a>
                                </div>                                
                                <div v-else-if="hm.ProcessStep=='UnitSended'">                                            
                                    <a href = "#" @click="evaluate(hm.id, 'view');" :title = "[hm.UnitSenderName, hm.UnitSenderPhone, hm.UnitDateSended ]" class = "text-muted">
                                        <strong>[[ hm.UnitTroubleScore ]] </strong>&nbsp;
                                        <i class="fa fa-check text-success icon-size" ></i>
                                    </a> 
                                </div>                                      
                            </td>
                            <td> <!-- Admin -->
                                <div v-if="hm.IsPersonEval">
                                    [[ hm.PersonTroubleScore ]]
                                </div>
                                <div v-else-if="hm.ProcessStep === 'PersonProcess' ">
                                    <a class="fa-stack" style="vertical-align: top;" >
                                        <i class="far fa-tasks text-warning icon-size"></i>
                                        <i class="fas fa-question text-danger fa-stack-1x check-size" style="margin-top: 10px;margin-left: 10px;"></i>
                                    </a>
                                </div>
                            </td>
                            <td>
                                
                            </td>
                            <td>
                                <div v-if="hm.ProcessStep === 'PersonProcess' ">
                                    <span :title = "[hm.PersonRecieverName, hm.PersonRecieverPhone, hm.PersonDateRecieved ]">                                
                                        <small>รอประเมิน</small>
                                    </span>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>

                    
            {# Confirm modal #}
            <div class="modal fade" id="confirm_modal" tabindex="-1" aria-labelledby="confirm_modalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirm_modalLabel">ยืนยัน[[step_action]]</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">                
                        [[step_action]]คำขอบ้านพักของ "[[ confirm_text ]]" <br><br>
                        ** จะมีการบันทึกข้อมูลผู้[[step_action]]ลงระบบ
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" @click="ChangeProcessStep" class="btn btn-primary">ยืนยัน</button>
                    </div>
                    </div>
                </div>
            </div>
        </div> <!-- end vue app -->

    {% endif %}
{% endblock %}

{% block buttom_script %}

<script>
    const MainAPP = {
        delimiters: ['[[', ']]'],
        data() {
            return {
                test_counter: 0,
                unit_data_list_modal : null,
                confirm_modal : null,
                confirm_text :"",
                current_index: 0,
                show_rank_status : ["โสด","สมรส-อยู่ร่วมกัน",4,5,6,7],
                current_hr_id: 0,
                filter_data : 'all',
                num_report :[],
                change_process_step_to : "",
                step_action :"รับเรื่อง",

                object_list : [
                    {
                        counter : 1,
                        short_name : "{{ request.user.CurrentUnit}}",
                        unit_id : {{ request.user.CurrentUnit.id}},                        
                        num_RP : {{ hr.Num_RP }},
                        num_RS : {{ hr.Num_RS }},
                        num_UP : {{ hr.Num_UP }},
                        num_US : {{ hr.Num_US }},
                        num_PPPA : {{ hr.Num_PPPA }},
                        num_GH : {{ hr.Num_GH }}
                    } 
                ],
             
                card_static:[
                    {
                        color : "text-dark",
                        bgcolor : "bg-light",
                        awesome : "fa-pen",
                        text : "เริ่มกรอก" 
                    },
                    {                        
                        color : "text-white",
                        bgcolor : "bg-danger",
                        awesome : "fa-list",
                        text : "ส่งหน่วย"
                    },
                    {
                        color : "text-white",
                        bgcolor : "bg-warning",
                        awesome : "fa-cog fa-spin",
                        text : "นขต.รับ"
                    },
                    {
                        color : "text-white",
                        bgcolor : "bg-success",
                        awesome : "fa-check",
                        text : "นขต.ส่ง"
                    },
                    {
                        color : "text-white",
                        bgcolor : "bg-secondary",
                        awesome : "fa-paperclip",
                        text : "กพ.รับเรื่อง"
                    },
                    {
                        color : "text-white",
                        bgcolor : "bg-primary",
                        awesome : "fa-home",
                        text : "รับจัดสรร" 
                    }
                ],

                        
                unit_data : {
                    short_name : "",
                    HomeRequest : []
                }
            }
        },
        mounted() {
            //this.unit_data_list_modal = new bootstrap.Modal(document.getElementById("unit_data_list_modal"), {});
            this.confirm_modal = new bootstrap.Modal(document.getElementById("confirm_modal"), {});
            console.log("monted function");
            console.log("this.confirm_modal",this.confirm_modal);
            this.show_unit_data_list(1,{{ request.user.CurrentUnit.id}});
        },
        methods : {
            show_unit_data_list(index, unit_id){
                urltext = "{% url 'HomeRequest:unit_list_admin'  99999 %}";
                new_urltext = urltext.replace("99999",unit_id)
                //console.log(new_urltext);

                fetch(new_urltext)
                    .then(response => response.json())
                    .then(data => {
                        console.log("show_unit_data_list vdata = ",data);
                        this.current_index = index;
                        this.unit_data.HomeRequest = data;
                        this.unit_data.short_name = data[0]["UnitName"];

                        this.num_report[0] = this.object_list[index-1].num_RP ;
                        this.num_report[1] = this.object_list[index-1].num_RS ;
                        this.num_report[2] = this.object_list[index-1].num_UP ;
                        this.num_report[3] = this.object_list[index-1].num_US ;
                        this.num_report[4] = this.object_list[index-1].num_PPPA;
                        this.num_report[5] =  this.object_list[index-1].num_GH ;
                        //this.unit_data_list_modal.show();
                    });

            },
            show_hr_detail(hr_id){
                urltext = "{% url 'HomeRequest:md' 99999 %}"
        
                new_urltext = urltext.replace("99999",hr_id)
                // console.log(new_urltext)
                fetch_show_modal(new_urltext);
            },
            ConfirmChangeProcessStep(index, hr_id, step){
                this.current_index = index;
                this.current_hr_id = hr_id;
                this.change_process_step_to = step;
                switch(step){                            
                                case 'UP': this.step_action ="รับเรื่อง"
                                           break;
                                case 'US': this.step_action ="ส่งเรื่อง";
                                           break;                                
                            }
                this.confirm_text = this.unit_data.HomeRequest[index]["FullName"];                
                this.confirm_modal.show();
            },
            ChangeProcessStep(){
                
                urltext = "{% url 'HomeRequest:update_process_step' 88888 '99999' %}";
                urltext = urltext.replace("88888",this.current_hr_id)
                new_urltext = urltext.replace("99999",this.change_process_step_to)
                // console.log(new_urltext);

                fetch(new_urltext)
                    .then(response => response.json())
                    .then(data => {
                        console.log("data ",data);
                        if(data["success"])
                        {
                            this.confirm_modal.hide();
                            switch(this.change_process_step_to){                            
                                case 'UP': this.unit_data.HomeRequest[1]["ProcessStep"] = 'UnitProcess';
                                      break;
                                case 'US': this.unit_data.HomeRequest[1]["ProcessStep"] = 'UnitSended';
                                      break;
                            }
                        }
                        else
                            alert("เกิดข้อผิดพลาด ไม่สามารถรับเรื่องได้");
                    });
            },
            ProcessStepClass(hm_process_step)
            {
                
                switch(hm_process_step)
                {
                    case 'RequesterSended' :  return 'text-danger';
                    case 'UnitProcess' :      return 'text-warning';
                    case 'UnitSended' :       return 'text-success';
                    case 'PersonProcess' :    return 'text-secondary';
                    case 'GetHouse' :      return 'text-primary';
                }
                return '';
                
            },
            num_report_func(step_report)
            {   
                ci = this.current_index - 1 < 0 ? 0 : this.current_index - 1 ;             
                switch(step_report)
                {
                    case 1: return this.object_list[ci].num_RP;
                    case 2: return this.object_list[ci].num_RS;
                    case 3: return this.object_list[ci].num_UP;
                    case 4: return this.object_list[ci].num_US;
                    case 5: return this.object_list[ci].num_PP;
                    case 6: return this.object_list[ci].num_GH;
                }                 
            },
            filter_homerequest(step_report)
            {
                ProcessStep = ['RequesterProcess','RequesterSended','UnitProcess',
                               'UnitSended','PersonProcess','PersonApproved','GetHouse'
                            ];
                console.log(ProcessStep[step_report-1]);
                this.filter_data = ProcessStep[step_report-1];
            },
            toggle_display(status)
            {
                if(status == "หย่า/ม่าย")
                {
                    let index1 = this.show_rank_status.indexOf("หย่า");
                    let index2 = this.show_rank_status.indexOf("ม่าย");
                    if (index1 !== -1) 
                    {
                        this.show_rank_status.splice(index1,1);       
                        this.show_rank_status.splice(index2,1);       
                    }
                    else             
                    {
                        this.show_rank_status.push("หย่า");                  
                        this.show_rank_status.push("ม่าย");                  
                    }
                    return ;
                }  

                // กรณีอื่น ๆ 
                let index = this.show_rank_status.indexOf(status);
                // console.log(index);
                // console.log(status);
                // console.log(this.show_rank_status);
                if (index !== -1) 
                    this.show_rank_status.splice(index,1);       
                else             
                    this.show_rank_status.push(status);                  
            },
            show_doc(hm_id)
            {
                urltext = "{% url 'HomeRequest:doc' '99999' %}";
                docURL = urltext.replace("99999",hm_id);               
                window.open(docURL ,'_blank');
            },
            show_xls(unit_id)
            {
                urltext = "{% url 'HomeRequest:xls' '99999' %}";
                xlsURL = urltext.replace("99999",unit_id);               
                window.open(xlsURL ,'_blank');
            },
            evaluate(hm_id, editable)
            {
                if(editable == 'edit')
                    urltext = "{% url 'Trouble:eval' '99999' 'Unit' %}";
                else
                    urltext = "{% url 'Trouble:view_eval' '99999' 'Unit' %}";
                trouble_eval = urltext.replace("99999",hm_id);               
                window.open(trouble_eval ,'_self');
            }
        }       
        
    }

    Vue.createApp(MainAPP).mount('#MainAPP')
</script>
{% endblock buttom_script %}